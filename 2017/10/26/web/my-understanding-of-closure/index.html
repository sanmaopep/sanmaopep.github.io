<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="format-detection" content="email=no"><meta name="description"><meta name="keywords" content="毛怡伟,毛线"><title>我理解的闭包 - 玩毛线的毛线</title><link rel="stylesheet" href="/css/main_style.min.css"><link rel="icon" href="/favicon.ico"></head><body><input id="navi" type="checkbox"><ul class="main-navication"><li><a href="/"><span>Home</span></a></li><li><a href="https://github.com"><span>Github</span></a></li><li><a href="https://www.v2ex.com/"><span>V2EX</span></a></li></ul><div class="wrapper" id="wrap"><div class="post-header"><label class="navi-button light" for="navi">MENU</label><img class="background" src="/assets/cats.jpg"><div class="post-title"><h1 class="title">我理解的闭包</h1><ul class="meta"><li><i class="icon icon-author"></i>玩毛线的毛线</li><li><i class="icon icon-clock"></i>10 Minutes</li><li><i class="icon icon-calendar"></i>October 26, 2017</li></ul></div></div><div class="article-content" style="max-width:800px;"><p>闭包是前端开发中的一个重要概念，也是前端面试的必问问题之一。对于JavaScript初学者而言，闭包学习JavaScript的一大障碍。网上有很多闭包的教程，形象地告诉了我闭包长什么样。但是大部分教程没有对闭包的定义给出精准的表达，也没有对闭包背后的一些原理和逻辑进行解释。本文通过整合网上各路资料，对闭包前前后后的知识点进行梳理，希望可以帮助大家准确并且深刻理解闭包的概念。（本文假设大家对闭包有一定的理解）</p>
<h2 id="Scope"><a href="#Scope" class="headerlink" title="Scope"></a>Scope</h2><p>要理解闭包，先要理解一个重要概念—作用域。</p>
<blockquote>
<p>In computer programming, the scope of a name <strong>binding</strong> – an association of a <strong>name</strong> to an <strong>entity</strong>, such as a variable – is the <strong>region</strong> of a computer program <strong>where the binding is valid</strong>: where the name can be used to refer to the entity. </p>
<p>Such a region referred to as is  a <strong>scope block</strong>.</p>
<p>参考自<a href="https://en.wikipedia.org/wiki/Scope_(computer_science" target="_blank" rel="external">wiki百科 Scope (computer science)</a>#Lexical_scoping)</p>
</blockquote>
<p>scope又可以分为词法作用域（Lexical scope）和动态作用域(Dynamic scope)。两者区别与对<strong>区域</strong>这个概念的解读。Wiki百科对两者的解释如下：</p>
<blockquote>
<p>In languages with lexical scope (also called static scope), name resolution depends on the location in the source code and the <strong>lexical context</strong>, which is defined by where the named variable or function is defined. In contrast, in languages with dynamic scope the name resolution depends upon the program state when the name is encountered which is determined by the <strong>execution context</strong> or calling context. </p>
<p>参考自<a href="https://en.wikipedia.org/wiki/Scope_(computer_science" target="_blank" rel="external">wiki百科 Scope (computer science)</a>#Lexical_scoping)</p>
</blockquote>
<p>在词法作用域中，一个name是否有效取决于它在源代码中的位置，也就是词法上下文。而动态作用域要相对复杂一点，在动态作用域中，一个name是否有效取决于这个程序的运行时状态，也就是运行时上下文。</p>
<p>对词法作用域在JavaScript中的表现在本文不作阐述，具体参考这篇博文：<a href="http://www.cnblogs.com/wangfupeng1988/p/3991151.html" target="_blank" rel="external">深入理解javascript原型和闭包（12）——简介【作用域】</a></p>
<h2 id="对Closure的一些定义"><a href="#对Closure的一些定义" class="headerlink" title="对Closure的一些定义"></a>对Closure的一些定义</h2><blockquote>
<p>各种专业文献上的”闭包”（closure）定义非常抽象，很难看懂。我的理解是，闭包就是能够读取其他函数内部变量的函数。</p>
<p>参考自<a href="http://www.ruanyifeng.com/blog/2009/08/learning_javascript_closures.html" target="_blank" rel="external">阮一峰 学习Javascript闭包（Closure）</a></p>
<p>A <em>closure</em> is the combination of a function and the lexical environment within which that function was declared.</p>
<p>参考自<a href="https://link.zhihu.com/?target=https%3A//developer.mozilla.org/en-US/docs/Web/JavaScript/Closures" target="_blank" rel="external">MDN Closure</a></p>
</blockquote>
<p>MDN的定义指出了闭包需要的东西：<strong>闭包 = 函数 + 函数定义的词法上下文环境</strong>。阮一峰老师的定义指出了闭包产生的现象：一个函数能够<strong>读取其他函数内部变量</strong>。</p>
<blockquote>
<p>In programming languages, closures (also lexical closures or function closures) are techniques for implementing lexically scoped name binding in languages with first-class functions. </p>
<p>参考自<a href="https://en.wikipedia.org/wiki/Closure_(computer_programming" target="_blank" rel="external">wiki百科 Closure(computer programming)</a>)</p>
</blockquote>
<p>wiki百科上的定义指出了闭包需要的语言条件： <em>first-class functions</em>。关于这个知识点可以参考<a href="http://blog.leapoahead.com/2015/09/19/function-as-first-class-citizen/" target="_blank" rel="external">“函数是一等公民”背后的含义</a>。另外，定义中提到的<em>implementing lexically scoped name binding</em> ，即基于词法作用域的name绑定与scope中的binding概念相互照应。本质上就是说的就是词法作用域与变量有效性的关系。</p>
<blockquote>
<p>在JavaScript中，实现外部作用域访问内部作用域中变量的方法叫做闭包。</p>
<p>参考自《深入浅出Node.js》</p>
</blockquote>
<p>以上对闭包的定义都略有差别，有的将闭包定义为函数，有的将闭包定义为方法，也有将闭包定义为组合。我觉得将闭包理解为一个方法，或者某个东西都对。两种定义的方法都对我们理解闭包有帮助。</p>
<h2 id="JavaScript的闭包"><a href="#JavaScript的闭包" class="headerlink" title="JavaScript的闭包"></a>JavaScript的闭包</h2><p>我们都会遇到在一个外部函数套着一个内部函数的情况，比如说：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params">x</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> tmp = <span class="number">3</span>;</div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">b</span>(<span class="params">y</span>) </span>&#123;</div><div class="line">        alert(x + y + (++tmp));</div><div class="line">    &#125;</div><div class="line">  	b(<span class="number">2</span>);</div><div class="line">  	b(<span class="number">3</span>);</div><div class="line">&#125;</div><div class="line">foo(<span class="number">0</span>);</div></pre></td></tr></table></figure>
<p>在foo函数结束的时候，tmp就会被销毁。一般来说，当内部函数被return的时候，外部就可以引用内部的函数，闭包就会通过return而产生。如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params">x</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> tmp = <span class="number">3</span>;</div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">y</span>) </span>&#123;</div><div class="line">        alert(x + y + (++tmp));</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">var</span> bar = foo(<span class="number">2</span>); <span class="comment">// bar 现在是一个闭包</span></div><div class="line">bar(<span class="number">10</span>);</div></pre></td></tr></table></figure>
<p>按照我们原本的理解，在没有闭包的情况下，foo函数执行完，它内部的tmp变量就会被销毁，但是因为外部函数引用了内部的变量产生了闭包，内部函数的词法上下文没有被销毁，tmp变量也没有被销毁。</p>
<p>当然，也有不用闭包的return的例子，比如利用setInterval或者绑定一个事件等等方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">a</span>(<span class="params"></span>)</span>&#123;</div><div class="line">  <span class="keyword">var</span> temp = <span class="number">0</span>;<span class="comment">// let也可以</span></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">b</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(temp++);</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// setInterval可以产生闭包</span></div><div class="line">  setInterval(b,<span class="number">1000</span>);</div><div class="line">  <span class="comment">// 绑定可以产生闭包</span></div><div class="line">  <span class="built_in">window</span>.addEventListener(<span class="string">'click'</span>,b);</div><div class="line">  <span class="comment">// ajax传入callback可以产生闭包</span></div><div class="line">  ajax(b);</div><div class="line">  <span class="comment">// 或者直接把这个函数传给window或者其它函数外部的元素</span></div><div class="line">  <span class="built_in">window</span>.closure = b;</div><div class="line">&#125;</div><div class="line">a();</div></pre></td></tr></table></figure>
<p>可以看到，只要内部函数有机会在函数外部被调用，或者说<strong>内部函数被外部的某个变量引用</strong>，就会产生闭包。就像《深入浅出Node.js》中提到的那样：</p>
<blockquote>
<p>闭包是JavaScript中的高级特性，利用它可以产生很多巧妙的效果。它的问题在于，一旦有变量<strong>引用</strong>了这个中间函数，这个中间函数不会释放，同时也使得原始作用域不会得到释放。作用域中产生的内存占用也不会被释放。除非不再有引用，才会逐步释放。</p>
<p>参考自 《深入浅出Node.js》</p>
</blockquote>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://www.zhihu.com/question/20032419" target="_blank" rel="external">动态作用域和词法域的区别是什么？</a><br><a href="http://blog.leapoahead.com/2015/09/19/function-as-first-class-citizen/" target="_blank" rel="external">“函数是一等公民”背后的含义</a><br><a href="http://www.cnblogs.com/walter-white/p/4981151.html" target="_blank" rel="external">js闭包的概念作用域内存模型</a><br><a href="http://www.ruanyifeng.com/blog/2009/08/learning_javascript_closures.html" target="_blank" rel="external">阮一峰 学习Javascript闭包（Closure）</a><br><a href="http://www.cnblogs.com/Quains/archive/2011/04/12/2013121.html" target="_blank" rel="external">javascript基础拾遗——词法作用域</a><br><a href="http://www.cnblogs.com/wangfupeng1988/p/3991151.html" target="_blank" rel="external">深入理解javascript原型和闭包（12）——简介【作用域】</a></p>
</div><div class="article-meta" style="max-width:800px;"></div><div class="article-comment" style="max-width:800px;"><div class="ds-thread" id="ds-thread" data-thread-key="cj9aw721m0008hvcx9yve0af9" data-title="我理解的闭包" data-url="http://yoursite.com/2017/10/26/web/my-understanding-of-closure/" site-name="ueibo"></div><script>var siteName = document.getElementById('ds-thread').getAttribute('site-name');
var duoshuoQuery = {short_name: siteName};
(function() {
  var ds = document.createElement('script');
  ds.type = 'text/javascript';ds.async = true;
  ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
  ds.charset = 'UTF-8';
  (document.getElementsByTagName('head')[0] 
  || document.getElementsByTagName('body')[0]).appendChild(ds);
})();</script></div><ul class="navication"><li class="home"><a href="/"><i class="icon icon-home"></i></a></li><li><a href="/2017/10/22/web/react-two-way-binding/"><i class="icon icon-arror-right"></i></a></li></ul><div class="page-footer"><div class="top"><ul class="social"><li><a href="https://github.com/sanmaopep" title="Github" target="_blank"><i class="icon icon-github"></i></a></li></ul></div><div class="bottom"><p class="copyright">© 2017 玩毛线的毛线<br><small>POWER BY <a href="https://hexo.io" target="_blank">HEXO</a></small><small>, THEME BY <a href="https://github.com/BoizZ/hexo-theme-laughing" target="_blank">LAUGHING</a></small></p></div></div></div><script>var wrap = document.getElementById('wrap');
window.onload = function () {
  wrap.className += ' done';
}</script></body></html>